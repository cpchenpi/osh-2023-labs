# Lab2 实验记录
> PB21000039 陈骆鑫

## 1.目录导航

### `pwd`命令

查阅资料，可知linux下有多个返回当前工作目录的系统调用，我选择了`get_current_dir_name`。它无需传入参数，会`malloc`一块内存以返回数据；我们只要在输出后将其`free`即可。

### `cd`命令

经过测试，`chdir`系统调用支持`./`、`../`等格式，但不支持Bash支持的`~/`。因此，调用之前，我们应判断第一个字符是否为`~`，并将其替换为家目录。同时，Bash在`cd`无参数时会进入到家目录，对`args`的大小特判即可实现。家目录，即`HOME`环境变量，可以通过`getenv`获取（我们认为家目录不会随便更改，因此只在进入程序时读取一次）。

## 2.管道

### 实现

我们需要实现任意多条命令之间的管道。

考虑一般的合理情况。此时，有由`"|"`分隔的`n`条命令，那么要打开`n-1`条管道，第`i`条管道连接第`i`与`i+1`条命令。

管道可以由`pipe`函数创建，之后可以通过`dup2`函数将标准输入/输出重定向到管道的一端。

实现的思路很简洁，但实际上实现并不算简单。为了方便，我们选择了递归的实现方式：
- 先根据`"|"`将命令分割为多条，填充到命令队列中；之后每次递归从队列中取出一条命令，启动它的执行，并在队列中仍剩余命令时打开一个管道。
- 我们让同一个进程执行这一递归，并在每次递归中创建一个新进程，执行任务。注意执行任务需要知道它前后的管道，因此递归函数需要一个传递前一个管道的参数。
- 创建子进程会继承父进程所有的文件描述符，`dup2`也不会关闭原来的文件描述符；而为了确保完成任务，所有用不到的文件描述符需要立即关闭。因此，需要关闭的文件如下：
  - 在创建子进程后，父进程要立即关闭管道；
  - 在`dup2`之后，子进程要立即关闭管道。

## 3.重定向

### 实现

考虑实际情景下的合理操作：我们只会在管道的最开始重定向输入，在管道的末尾重定向输出。因此，我们选择在运行单个任务部分添加处理逻辑。同时，对“数字+符号”的判断相对较复杂，故我们实现了`>`、`>>`、`<`、`<<`、`<<<`五种重定向方式。
实现逻辑如下：
- 如果没有左侧的管道，检测最后两个单词是否为输入重定向。如果是，删除最后两个单词，并执行对应重定向。
  - `<`：用`open`打开对应文件，并用`dup2`重定向到输入。
  - `<<`：用`open`创建一个临时文件，在输入行不是对应符号的情况下不断填充文件；最后将读写指针定位到开头，并用`dup2`重定向到输入。
  - `<`：用`open`创建一个临时文件，输入最后一个单词；最后将读写指针定位到开头，并用`dup2`重定向到输入。
- 如果没有右侧的管道，检测最后两个单词是否为输出重定向。如果是，删除最后两个单词，并执行对应重定向。
  - `<`/`<<`：用`open`以对应模式打开对应文件，并用`dup2`重定向到输出。
- **注意**：可以看到这样的实现方式有一定的局限性：重定向必须位于最后。而经过测试，Bash似乎使用词法分析的方式来解析`>`运算符和其参数。